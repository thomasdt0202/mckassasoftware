<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuseumCatering Kassa V3.0</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/cash-register.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-body: #f1f5f9; --bg-panel: #ffffff; --text-main: #0f172a; --text-muted: #64748b; --border: #e2e8f0; --primary: #0f172a; --accent: #2563eb; --success: #16a34a; --warning: #f59e0b; --danger: #ef4444; --gold: #fbbf24; --radius: 12px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-body); height: 100dvh; display: flex; overflow: hidden; color: var(--text-main); }
        button { border: none; outline: none; font-family: inherit; cursor: pointer; touch-action: manipulation; }
        .app-container { display: flex; width: 100%; height: 100%; position: relative; z-index: 1; }
        .left-panel { flex: 66; display: flex; flex-direction: column; padding: 16px; gap: 16px; }
        .right-panel { flex: 34; background: var(--bg-panel); display: flex; flex-direction: column; border-left: 1px solid var(--border); box-shadow: -4px 0 24px rgba(0,0,0,0.05); z-index: 20; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); padding: 12px 20px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); height: 64px; }
        .top-bar.training-mode { background: #0ea5e9; color: white; }
        .brand { font-size: 1.25rem; font-weight: 900; letter-spacing: -0.02em; }
        .status-indicators { display: flex; gap: 8px; }
        .status-pill { background: var(--bg-body); padding: 6px 12px; border-radius: 99px; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .dot.ok { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot.sync { background: var(--warning); animation: blink 1s infinite; }
        .dot.err { background: var(--danger); }
        .cat-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .cat-btn { padding: 14px 20px; background: var(--bg-panel); border-radius: 10px; font-weight: 700; color: var(--text-muted); font-size: 0.95rem; border: 1px solid var(--border); white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(135px, 1fr)); gap: 12px; flex: 1; overflow-y: auto; padding-bottom: 20px; align-content: start; }
        .p-card { background: var(--bg-panel); border-radius: var(--radius); padding: 12px; height: 110px; position: relative; display: flex; flex-direction: column; justify-content: space-between; border: 2px solid transparent; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: 0.1s; }
        .p-card:active { transform: scale(0.96); background: #e2e8f0; }
        .p-card.cat-style-0 { border-bottom: 4px solid #bfdbfe; } /* Fris */
        .p-card.cat-style-1 { border-bottom: 4px solid #fed7aa; } /* Warm */
        .p-card.cat-style-2 { border-bottom: 4px solid #e9d5ff; } /* Alcohol */
        .p-card.cat-style-3 { border-bottom: 4px solid #fbcfe8; } /* Zoet */
        .p-card.cat-style-4 { border-bottom: 4px solid #bbf7d0; } /* Eten */
        .p-card.cat-style-5 { border-bottom: 4px solid #e2e8f0; } /* Divers */
        .p-name { font-weight: 700; font-size: 0.95rem; line-height: 1.25; }
        .p-price { font-weight: 600; color: var(--text-muted); align-self: flex-end; font-size: 0.9rem; }
        .p-badge { position: absolute; top: -6px; right: -6px; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem; font-weight: 800; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.5); transition: 0.2s; }
        .p-badge.visible { opacity: 1; transform: scale(1); }
        .suggest-gold { border-color: var(--gold) !important; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.3) !important; animation: pulseGold 1.5s infinite; z-index: 10; }
        .ticket-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .ticket-title { font-weight: 800; font-size: 1.1rem; }
        .last-bill { font-size: 0.8rem; font-weight: 600; color: var(--accent); cursor: pointer; padding: 4px 8px; background: #eff6ff; border-radius: 6px; }
        .cart-items { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .cart-row { display: grid; grid-template-columns: 40px 1fr auto 32px; gap: 10px; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); animation: slideIn 0.2s; }
        .qty-box { background: #eff6ff; color: var(--accent); font-weight: 800; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .del-btn { color: var(--danger); font-size: 1.4rem; cursor: pointer; display: flex; justify-content: center; }
        .action-panel { background: white; padding: 16px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
        .total-amount { font-size: 2.5rem; font-weight: 900; line-height: 1; color: var(--primary); text-align: right; margin-bottom: 5px;}
        .pay-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; height: 75px; }
        .btn-pay { border-radius: var(--radius); font-weight: 800; font-size: 1.2rem; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; }
        .bg-cash { background: var(--accent); } .bg-pin { background: var(--success); }
        .btn-opt { width: 100%; padding: 12px; border-radius: 8px; font-weight: 700; background: var(--bg-body); color: var(--text-muted); border: 1px solid var(--border); display: flex; justify-content: space-between; }
        .btn-opt.active { background: #fff7ed; color: #c2410c; border-color: #f97316; }
        .report-btn { width:100%; text-align:center; padding:10px; font-weight:700; color:var(--primary); text-decoration:underline; cursor:pointer; font-size:0.9rem; }
        .footer-tools { display: flex; justify-content: space-between; margin-top:5px; font-size:0.8rem; color:var(--text-muted);}
        .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-backdrop.open { display: flex; }
        .modal-content { background: white; width: 600px; max-width: 95%; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; margin-bottom: 20px; }
        .report-table td { padding: 8px 0; border-bottom: 1px dashed #e2e8f0; }
        .report-qty { font-weight: 800; color: var(--primary); width: 40px; }
        .report-h { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; border-bottom: 2px solid var(--border); margin-top: 15px; margin-bottom: 10px; padding-bottom: 5px; }
        .report-h.staff { color: #c2410c; border-color: #fdba74; }
        #flash-overlay { position: fixed; inset: 0; background: rgba(22, 163, 74, 0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        #flash-overlay.visible { opacity: 1; }
        .alert-banner { position: fixed; top: 0; left: 0; right: 0; padding: 20px; text-align: center; font-weight: 800; transform: translateY(-100%); transition: 0.5s; z-index: 1500; }
        .alert-banner.show { transform: translateY(0); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .num-key { padding: 20px; font-size: 1.5rem; font-weight: 700; background: #f1f5f9; border-radius: 10px; }
        @keyframes pulseGold { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        @keyframes blink { 50% { opacity: 0.4; } }
    </style>
</head>
<body>

<div id="flash-overlay"><div style="font-size:8rem; color:white;">‚úì</div></div>
<div id="haccp-alert" class="alert-banner" style="background:#f59e0b; color:#78350f;" onclick="this.classList.remove('show')">‚ö†Ô∏è Taartjes Borgen!</div>
<div id="closing-alert" class="alert-banner" style="background:#ef4444; color:white; height:100vh; display:flex; flex-direction:column; justify-content:center; font-size:3rem;" onclick="this.classList.remove('show')">GESLOTEN</div>

<div id="modal-cash" class="modal-backdrop">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header"><h3>Contant</h3><button onclick="App.ui.closeModal('modal-cash')" style="font-size:2rem; background:none;">&times;</button></div>
        <div class="modal-body">
            <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px; font-size:1.2rem;">
                <div style="display:flex; justify-content:space-between;"><span>Te betalen:</span><span id="cash-req" style="font-weight:bold;">‚Ç¨ 0,00</span></div>
                <div style="display:flex; justify-content:space-between; margin-top:10px;"><span>Ontvangen:</span><span id="cash-given" style="font-weight:bold; color:#2563eb;">‚Ç¨ 0,00</span></div>
                <div style="border-top:2px dashed #ccc; margin-top:15px; padding-top:15px; display:flex; justify-content:space-between; font-weight:900; color:#ef4444;"><span>TERUG:</span><span id="cash-change">‚Ç¨ 0,00</span></div>
            </div>
            <div id="cash-options" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
            <button onclick="App.payment.confirmCash()" style="width:100%; background:#16a34a; color:white; padding:20px; border-radius:12px; font-weight:800; margin-top:20px;">AFRONDEN</button>
        </div>
    </div>
</div>

<div id="modal-open" class="modal-backdrop">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header"><h3>Open Bedrag</h3><button onclick="App.ui.closeModal('modal-open')" style="font-size:2rem; background:none;">&times;</button></div>
        <div class="modal-body">
            <div id="numpad-display" style="text-align:right; font-size:2.5rem; font-weight:900; background:#f8fafc; padding:20px; border-radius:12px;">0,00</div>
            <div class="numpad" id="numpad-keys"></div>
        </div>
    </div>
</div>

<div id="modal-report" class="modal-backdrop">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header" style="background:#f8fafc;"><h3>Dagrapportage</h3><button onclick="App.ui.closeModal('modal-report')" style="font-size:2rem; background:none;">&times;</button></div>
        <div class="modal-body">
            <div id="report-content"></div>
            <hr style="margin:20px 0;">
            <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:5px;"><span>Totaal PIN:</span><span id="rep-pin" style="color:#16a34a">‚Ç¨ 0,00</span></div>
                <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>Totaal CASH:</span><span id="rep-cash" style="color:#2563eb">‚Ç¨ 0,00</span></div>
            </div>
            <button onclick="App.manager.resetSession()" style="width:100%; padding:20px; background:#ef4444; color:white; font-weight:bold; border-radius:10px;">SESSIE AFSLUITEN & WISSEN</button>
        </div>
    </div>
</div>

<div id="modal-history" class="modal-backdrop">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header"><h3>Historie</h3><button onclick="App.ui.closeModal('modal-history')" style="font-size:2rem; background:none;">&times;</button></div>
        <div class="modal-body" id="history-list" style="background:#f1f5f9; min-height:300px;"></div>
    </div>
</div>

<div class="app-container" id="app-wrapper">
    <div class="left-panel">
        <div class="top-bar" id="top-bar">
            <div class="brand">MuseumCatering</div>
            <div class="status-indicators">
                <div class="status-pill">üîã <span id="bat-level">--%</span></div>
                <div class="status-pill"><div class="dot ok" id="net-dot"></div> <span id="net-text">Online</span></div>
                <div class="status-pill">üïí <span id="clock">00:00</span></div>
            </div>
        </div>
        <div class="cat-scroll" id="cat-tabs"></div>
        <div class="product-grid" id="prod-grid"></div>
    </div>

    <div class="right-panel">
        <div class="ticket-header">
            <div class="ticket-title">Huidige Bon</div>
            <div class="last-bill" onclick="App.ui.openHistory()">Laatste: <span id="last-bill-amt">‚Ç¨ 0,00</span></div>
        </div>
        <div class="cart-items" id="cart-list"></div>
        <div class="action-panel">
            <div class="total-amount" id="total-display">‚Ç¨ 0,00</div>
            <div class="pay-grid">
                <button class="btn-pay bg-cash" id="btn-cash" onclick="App.payment.startCash()">CONTANT</button>
                <button class="btn-pay bg-pin" id="btn-pin" onclick="App.payment.payPin()">PIN</button>
            </div>
            <button class="btn-opt" id="btn-disc" onclick="App.cart.toggleDiscount()"><span>% Personeelskorting</span><span id="disc-status">UIT</span></button>
            <div class="report-btn" onclick="App.manager.openReport()">Dagrapportage & Afsluiten</div>
            <div class="footer-tools">
                <span style="color:#ef4444; cursor:pointer; font-weight:bold;" onclick="App.cart.clear()">√ó Bon Wissen</span>
                <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="chk-training" onchange="App.settings.toggleTraining()"> Training</label>
            </div>
        </div>
    </div>
</div>

<script>
const CONFIG = {
    // ‚ö†Ô∏è PLAK HIER JOUW APPS SCRIPT URL:
    GOOGLE_URL: "https://script.google.com/macros/s/AKfycbw4HCKu5DRqDvC6SsqdxhpVviAlSc1Se18gsQFSOEA70h2DkOHI6OBpb_ca4kxccMfjMA/exec",
    
    CATS: ["Frisdrank", "Warme Dranken", "Alcohol", "Zoetigheden", "Brood/Warm", "Diversen"],
    PRODUCTS: [
        {c:0, n:"Chocomel", p:3.50}, {c:0, n:"Cola", p:3.50}, {c:0, n:"Cola Zero", p:3.50}, {c:0, n:"Spa Blauw", p:3.50}, {c:0, n:"Spa Rood", p:3.50}, {c:0, n:"Schulp Appel", p:3.85}, {c:0, n:"Schulp Vlierbes", p:3.85}, {c:0, n:"Lemon-aid Passie", p:4.75}, {c:0, n:"Lemon-aid Bloed", p:4.75}, {c:0, n:"Lemon-aid Ginger", p:4.75}, {c:0, n:"Charitea", p:4.75}, {c:0, n:"Melk", p:3.00}, {c:0, n:"Karnemelk", p:3.00}, {c:0, n:"Verse Jus", p:5.25}, {c:0, n:"Glas Limonade", p:1.00}, {c:0, n:"Sinaasappel Aardbei", p:5.25},
        {c:1, n:"Koffie", p:3.40}, {c:1, n:"Cappuccino", p:3.75}, {c:1, n:"Koffie Verkeerd", p:4.20}, {c:1, n:"Latte Macchiato", p:4.20}, {c:1, n:"Flat White", p:4.20}, {c:1, n:"Espresso", p:3.40}, {c:1, n:"Espresso Macch.", p:3.45}, {c:1, n:"Dubbele Espresso", p:4.00}, {c:1, n:"Havermelk", p:0.60}, {c:1, n:"Thee", p:3.50}, {c:1, n:"Gember Thee", p:3.95}, {c:1, n:"Munt Thee", p:3.95}, {c:1, n:"Warme Choco", p:3.95}, {c:1, n:"Slagroom", p:0.75},
        {c:2, n:"DHP Pilsener", p:5.00}, {c:2, n:"DHP Weizener", p:5.50}, {c:2, n:"DHP IPA", p:5.50}, {c:2, n:"Leffe", p:5.25}, {c:2, n:"Hertog Jan", p:3.75}, {c:2, n:"Glas Wijn", p:5.25},
        {c:3, n:"Appeltaart", p:5.50}, {c:3, n:"Worteltaart", p:5.50}, {c:3, n:"Titanic Gold", p:5.50}, {c:3, n:"Citroen Meringue", p:5.50}, {c:3, n:"Croissant", p:3.50}, {c:3, n:"Pain au Chocolat", p:3.50}, {c:3, n:"Slagroom", p:0.75}, {c:3, n:"Brownie", p:4.95}, {c:3, n:"Macaron", p:2.00}, {c:3, n:"Kinderdonut", p:3.50}, {c:3, n:"Poffertjes", p:3.95}, {c:3, n:"IJsje", p:2.00},
        {c:4, n:"Br. Oude Kaas", p:9.50}, {c:4, n:"Br. Tonijn", p:9.50}, {c:4, n:"Br. Gr. Groenten", p:9.50}, {c:4, n:"Br. Gehaktbal", p:9.50}, {c:4, n:"Salade Tonijn", p:12.00}, {c:4, n:"Sal. Geitenkaas", p:12.00}, {c:4, n:"Kaasbroodje", p:3.75}, {c:4, n:"Saucijsbroodje", p:3.75}, {c:4, n:"Quiche", p:3.95}, {c:4, n:"Soep", p:6.50}, {c:4, n:"Soepbroodje", p:0.50},
        {c:5, n:"Open Bedrag", p:0, special:true}
    ]
};

const State = {
    cart: [],
    queue: JSON.parse(localStorage.getItem('mc_queue')) || [],
    history: JSON.parse(localStorage.getItem('mc_history')) || [],
    activeCat: 0, discount: false, training: false, isProcessing: false, numpadVal: "", lastCashGiven: 0
};

const Utils = {
    formatPrice: (num) => `‚Ç¨ ${num.toFixed(2).replace('.', ',')}`,
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    round: (num) => Math.round(num * 100) / 100
};

const App = {
    init: () => {
        App.ui.renderCats(); App.ui.renderGrid(); App.ui.renderCart();
        App.ui.updateClock(); App.ui.initNumpad(); App.net.startQueueProcessor();
        App.net.initBattery(); App.ui.updateLastBill();
        setInterval(App.ui.updateClock, 1000);
    },

    cart: {
        add: (name, price, catIdx) => {
            if(State.isProcessing) return;
            let item = State.cart.find(x => x.n === name);
            if(item) item.q++; else State.cart.push({ n:name, p:price, q:1, c:catIdx });
            if(catIdx === 1) App.ui.triggerGold();
            App.ui.renderCart(); App.ui.renderGrid();
        },
        remove: (idx) => { if(State.cart[idx].q > 1) State.cart[idx].q--; else State.cart.splice(idx, 1); App.ui.renderCart(); App.ui.renderGrid(); },
        clear: () => { if(confirm("Bon wissen?")) { State.cart = []; State.discount=false; App.ui.renderCart(); App.ui.renderGrid(); } },
        toggleDiscount: () => { State.discount = !State.discount; App.ui.renderCart(); },
        calculateTotal: () => {
            let sub = State.cart.reduce((a, b) => a + (b.p * b.q), 0);
            return State.discount ? Utils.round(sub * 0.75) : Utils.round(sub);
        }
    },

    payment: {
        startCash: () => {
            if(State.cart.length===0 || State.isProcessing) return;
            const total = App.cart.calculateTotal();
            document.getElementById('cash-req').innerText = Utils.formatPrice(total);
            const opts = [total]; if(total%5!==0) opts.push(Math.ceil(total/5)*5); if(total%10!==0) opts.push(Math.ceil(total/10)*10);
            if(total<20) opts.push(20); if(total<50) opts.push(50);
            document.getElementById('cash-options').innerHTML = [...new Set(opts)].sort((a,b)=>a-b).map(amt => 
                `<button class="btn-pay" style="background:white; color:#0f172a; border:2px solid #e2e8f0; height:60px;" onclick="App.payment.selectCash(${amt}, ${total})">‚Ç¨ ${amt.toFixed(2)}</button>`
            ).join('');
            App.ui.openModal('modal-cash');
        },
        selectCash: (amt, total) => {
            State.lastCashGiven = amt;
            document.getElementById('cash-given').innerText = Utils.formatPrice(amt);
            document.getElementById('cash-change').innerText = Utils.formatPrice(amt - total);
        },
        confirmCash: () => { if(State.lastCashGiven===0) State.lastCashGiven=App.cart.calculateTotal(); App.ui.closeModal('modal-cash'); App.payment.process("CONTANT"); },
        payPin: () => { if(State.cart.length>0 && !State.isProcessing) App.payment.process("PIN"); },
        process: (type) => {
            State.isProcessing = true; App.ui.setLoading(true);
            if(State.training) { App.payment.finish(true); return; }
            
            const total = App.cart.calculateTotal();
            const itemsFlat = [];
            const breakdown = {};
            State.cart.forEach(item => {
                itemsFlat.push(`${item.q}x ${item.n}`);
                const catName = CONFIG.CATS[item.c] || "Diversen";
                if(!breakdown[catName]) breakdown[catName] = 0;
                breakdown[catName] += (item.p * item.q);
            });
            if(State.discount) for(let k in breakdown) breakdown[k] = Utils.round(breakdown[k] * 0.75);
            else for(let k in breakdown) breakdown[k] = Utils.round(breakdown[k]);

            const record = { id: Utils.uuid(), time: new Date().toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit'}), type: type, total: total, items: itemsFlat, catBreakdown: breakdown, isDiscounted: State.discount, device: "Tablet V2" };
            State.history.push(record); localStorage.setItem('mc_history', JSON.stringify(State.history));
            App.net.addToQueue(record);
            App.payment.finish(false);
        },
        finish: (isTraining) => {
            State.cart = []; State.discount = false;
            document.getElementById('flash-overlay').classList.add('visible');
            setTimeout(() => document.getElementById('flash-overlay').classList.remove('visible'), 600);
            App.ui.renderCart(); App.ui.renderGrid(); App.ui.updateLastBill();
            setTimeout(() => { State.isProcessing = false; App.ui.setLoading(false); }, 1000);
        }
    },

    manager: {
        openReport: () => {
            let counts = {}; let staffCounts = {}; let pinTotal = 0; let cashTotal = 0;
            State.history.forEach(tx => {
                if(tx.type === "PIN") pinTotal += tx.total; else cashTotal += tx.total;
                let itemsArr = Array.isArray(tx.items) ? tx.items : (tx.items ? [tx.items] : []);
                itemsArr.forEach(itemStr => {
                    let s = String(itemStr); let parts = s.includes('x ') ? s.split('x ') : [1, s];
                    let q = parseInt(parts[0]) || 1; let name = parts[1] || s;
                    if(tx.isDiscounted) staffCounts[name] = (staffCounts[name] || 0) + q; else counts[name] = (counts[name] || 0) + q;
                });
            });
            let html = "";
            const buildTable = (data, title, isStaff) => {
                let keys = Object.keys(data).sort(); if(keys.length === 0) return "";
                let tbl = `<div class="report-h ${isStaff?'staff':''}">${title}</div><table class="report-table">`;
                keys.forEach(k => { tbl += `<tr><td class="report-qty">${data[k]}</td><td>${k}</td></tr>`; }); return tbl + "</table>";
            };
            html += buildTable(counts, "Normale Verkoop", false); html += buildTable(staffCounts, "Personeel / Korting", true);
            if(html === "") html = "<div style='text-align:center; padding:20px; color:#94a3b8'>Nog geen verkopen.</div>";
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('rep-pin').innerText = Utils.formatPrice(pinTotal);
            document.getElementById('rep-cash').innerText = Utils.formatPrice(cashTotal);
            App.ui.openModal('modal-report');
        },
        resetSession: () => { if(confirm("Sessie afsluiten?")) { State.history = []; localStorage.setItem('mc_history', JSON.stringify([])); location.reload(); } },
        undo: (id) => {
            if(!confirm("Bon crediteren?")) return;
            let tx = State.history.find(h => String(h.id) === String(id));
            if(tx) {
                let negativeCats = {}; let hasCats = false;
                if (tx.catBreakdown && typeof tx.catBreakdown === 'object') {
                    for (let key in tx.catBreakdown) {
                        let val = parseFloat(tx.catBreakdown[key]);
                        if(val !== 0) { negativeCats[key] = -Math.abs(val); hasCats = true; }
                    }
                }
                if (!hasCats) negativeCats["Diversen"] = -Math.abs(tx.total);
                
                let cor = { id: "COR-" + Utils.uuid(), time: new Date().toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit'}), total: -Math.abs(tx.total), items: ["CORRECTIE: " + (Array.isArray(tx.items)?tx.items.join(", "):tx.items)], catBreakdown: negativeCats, type: tx.type, device: "Tablet Correctie", isDiscounted: tx.isDiscounted||false };
                App.net.addToQueue(cor);
                State.history = State.history.filter(h => String(h.id) !== String(id)); localStorage.setItem('mc_history', JSON.stringify(State.history));
                App.ui.openHistory(); App.ui.updateLastBill();
            } else { alert("Fout: Bon niet gevonden."); }
        }
    },

    net: {
        addToQueue: (data) => { State.queue.push({ data: data }); localStorage.setItem('mc_queue', JSON.stringify(State.queue)); App.net.processQueue(); },
        processQueue: () => {
            if(State.queue.length === 0 || !navigator.onLine) { App.ui.updateNetStatus(); return; }
            fetch(CONFIG.GOOGLE_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(State.queue[0].data) })
            .then(() => { State.queue.shift(); localStorage.setItem('mc_queue', JSON.stringify(State.queue)); if(State.queue.length>0) setTimeout(App.net.processQueue, 300); App.ui.updateNetStatus(); })
            .catch(e => { console.error(e); App.ui.updateNetStatus(); });
        },
        startQueueProcessor: () => { window.addEventListener('online', ()=>{App.net.processQueue(); App.ui.updateNetStatus();}); setInterval(App.net.processQueue, 10000); },
        initBattery: () => { if(navigator.getBattery) navigator.getBattery().then(b => { const u=()=>document.getElementById('bat-level').innerText=Math.round(b.level*100)+"%"; u(); b.addEventListener('levelchange', u); }); }
    },

    ui: {
        renderCats: () => { document.getElementById('cat-tabs').innerHTML = CONFIG.CATS.map((n, i) => `<button class="cat-btn ${i===State.activeCat?'active':''}" onclick="App.ui.setCat(${i})">${n}</button>`).join(''); },
        setCat: (i) => { State.activeCat = i; App.ui.renderCats(); App.ui.renderGrid(); },
        renderGrid: () => {
            document.getElementById('prod-grid').innerHTML = CONFIG.PRODUCTS.filter(p => p.c === State.activeCat).map(p => {
                const inCart = State.cart.find(x => x.n === p.n);
                const badge = inCart ? `<div class="p-badge visible">${inCart.q}</div>` : `<div class="p-badge"></div>`;
                const action = p.special ? `App.ui.openNumpad()` : `App.cart.add('${p.n}', ${p.p}, ${p.c})`;
                const extra = p.c===3 ? 'suggest-target' : '';
                return `<div class="p-card cat-style-${p.c} ${extra}" onclick="${action}">${badge}<div class="p-name">${p.n}</div><div class="p-price">${p.special?"...":Utils.formatPrice(p.p)}</div></div>`;
            }).join('');
        },
        renderCart: () => {
            const list = document.getElementById('cart-list');
            if(State.cart.length===0) list.innerHTML = `<div style="text-align:center; color:#cbd5e1; margin-top:50px;">üõí Leeg</div>`;
            else list.innerHTML = State.cart.map((item, i) => `<div class="cart-row"><div class="qty-box" onclick="App.cart.add('${item.n}',${item.p},${item.c})">${item.q}</div><div><div style="font-weight:700; font-size:0.9rem;">${item.n}</div></div><div style="font-weight:700;">${Utils.formatPrice(item.p*item.q)}</div><div class="del-btn" onclick="App.cart.remove(${i})">&minus;</div></div>`).join('');
            document.getElementById('total-display').innerText = Utils.formatPrice(App.cart.calculateTotal());
            const active = State.cart.length>0 && !State.isProcessing;
            document.getElementById('btn-cash').style.opacity = active ? 1 : 0.5;
            document.getElementById('btn-pin').style.opacity = active ? 1 : 0.5;
            if(State.discount) { document.getElementById('btn-disc').classList.add('active'); document.getElementById('disc-status').innerText="AAN"; }
            else { document.getElementById('btn-disc').classList.remove('active'); document.getElementById('disc-status').innerText="UIT"; }
            list.scrollTop = list.scrollHeight;
        },
        updateClock: () => {
            const now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit'});
            if([10,12,14,16].includes(now.getHours()) && now.getMinutes()===0 && now.getSeconds()===0) document.getElementById('haccp-alert').classList.add('show');
            if(now.getHours()===16 && now.getMinutes()===45 && now.getSeconds()===0) document.getElementById('closing-alert').classList.add('show');
        },
        triggerGold: () => { document.querySelectorAll('.suggest-target').forEach(e => { e.classList.add('suggest-gold'); setTimeout(()=>e.classList.remove('suggest-gold'), 5000); }); },
        setLoading: (b) => document.getElementById('app-wrapper').style.opacity = b ? 0.7 : 1,
        openModal: (id) => document.getElementById(id).classList.add('open'),
        closeModal: (id) => document.getElementById(id).classList.remove('open'),
        updateLastBill: () => { if(State.history.length>0) document.getElementById('last-bill-amt').innerText = Utils.formatPrice(State.history[State.history.length-1].total); },
        updateNetStatus: () => { const d=document.getElementById('net-dot'), t=document.getElementById('net-text'); if(!navigator.onLine){d.className="dot err";t.innerText="Offline";} else if(State.queue.length>0){d.className="dot sync";t.innerText="Sync...";} else {d.className="dot ok";t.innerText="Online";} },
        openHistory: () => {
            document.getElementById('history-list').innerHTML = State.history.slice().reverse().map(h => `<div style="background:white; padding:10px; margin-bottom:8px; border-radius:8px; border:1px solid #e2e8f0;"><div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${h.time} (${h.type})</span><span>${Utils.formatPrice(h.total)}</span></div><div style="font-size:0.8rem; color:#64748b;">${Array.isArray(h.items)?h.items.join(', '):h.items}</div><button onclick="App.manager.undo('${h.id}')" style="color:#ef4444; background:#fef2f2; padding:4px 8px; border-radius:4px; margin-top:5px; font-weight:bold; font-size:0.7rem;">CREDITEER</button></div>`).join('');
            App.ui.openModal('modal-history');
        },
        initNumpad: () => { document.getElementById('numpad-keys').innerHTML = [7,8,9,4,5,6,1,2,3,'.',0,'OK'].map(k => `<button class="num-key" onclick="${k==='OK'?'App.ui.confirmNumpad()':`App.ui.typeNumpad('${k}')`}" style="${k==='OK'?'background:#16a34a; color:white':''}">${k}</button>`).join(''); },
        typeNumpad: (k) => { State.numpadVal += k; document.getElementById('numpad-display').innerText = State.numpadVal; },
        confirmNumpad: () => { let v = parseFloat(State.numpadVal.replace(',','.')); if(v>0) App.cart.add("Diversen", v, 5); App.ui.closeModal('modal-open'); State.numpadVal=""; },
        
        // Settings / Tools
        toggleTraining: () => {
            State.training = document.getElementById('chk-training').checked;
            const bar = document.getElementById('top-bar');
            if(State.training) bar.classList.add('training-mode'); else bar.classList.remove('training-mode');
        }
    }
};

window.onload = App.init;
</script>
</body>
</html>
