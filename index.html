<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuseumCatering POS Pro</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/cash-register.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/cash-register.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f1f5f9;
            --bg-panel: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --primary: #0f172a;
            --accent: #2563eb;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gold: #fbbf24;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --trans-fast: 0.15s ease;
        }

        /* --- BASE RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg-body); height: 100dvh; display: flex; overflow: hidden; color: var(--text-main); }
        button { border: none; outline: none; font-family: inherit; cursor: pointer; touch-action: manipulation; }
        
        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; position: relative; z-index: 1; transition: box-shadow 0.3s; }
        .app-container.busy-level-1 { box-shadow: inset 0 0 30px rgba(245, 158, 11, 0.2); }
        .app-container.busy-level-2 { box-shadow: inset 0 0 50px rgba(239, 68, 68, 0.4); border: 3px solid var(--danger); }

        .left-panel { flex: 66; display: flex; flex-direction: column; padding: 16px; gap: 16px; }
        .right-panel { flex: 34; background: var(--bg-panel); display: flex; flex-direction: column; border-left: 1px solid var(--border); box-shadow: -4px 0 24px rgba(0,0,0,0.05); z-index: 20; }

        /* --- TOP BAR --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: var(--bg-panel); padding: 12px 20px; border-radius: var(--radius); box-shadow: var(--shadow); height: 64px; }
        .top-bar.training-mode { background: #0ea5e9; color: white; }
        .brand { font-size: 1.25rem; font-weight: 900; letter-spacing: -0.02em; }
        
        .status-indicators { display: flex; gap: 8px; }
        .status-pill { background: var(--bg-body); padding: 6px 12px; border-radius: 99px; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; color: var(--text-muted); border: 1px solid transparent; }
        .top-bar.training-mode .status-pill { background: rgba(255,255,255,0.2); color: white; }
        
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .dot.ok { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot.sync { background: var(--warning); animation: blink 1s infinite; }
        .dot.err { background: var(--danger); }

        /* --- CATEGORIES --- */
        .cat-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .cat-btn { padding: 14px 20px; background: var(--bg-panel); border-radius: 10px; font-weight: 700; color: var(--text-muted); font-size: 0.95rem; border: 1px solid var(--border); white-space: nowrap; transition: var(--trans-fast); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        .cat-btn:active { transform: scale(0.96); }

        /* --- PRODUCT GRID --- */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(135px, 1fr)); gap: 12px; flex: 1; overflow-y: auto; padding-bottom: 20px; align-content: start; }
        .p-card { background: var(--bg-panel); border-radius: var(--radius); padding: 12px; height: 110px; position: relative; display: flex; flex-direction: column; justify-content: space-between; border: 2px solid transparent; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: var(--trans-fast); }
        .p-card:active { transform: scale(0.94); background: #e2e8f0; }
        
        /* Category Colors */
        .cat-style-0 { border-bottom: 4px solid #bfdbfe; } /* Fris */
        .cat-style-1 { border-bottom: 4px solid #fed7aa; } /* Warm */
        .cat-style-2 { border-bottom: 4px solid #e9d5ff; } /* Alcohol */
        .cat-style-3 { border-bottom: 4px solid #fbcfe8; } /* Zoet */
        .cat-style-4 { border-bottom: 4px solid #bbf7d0; } /* Eten */
        .cat-style-5 { border-bottom: 4px solid #e2e8f0; } /* Divers */

        .p-name { font-weight: 700; font-size: 0.95rem; line-height: 1.25; color: var(--text-main); }
        .p-price { font-weight: 600; color: var(--text-muted); align-self: flex-end; font-size: 0.9rem; }
        .p-badge { position: absolute; top: -6px; right: -6px; background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8rem; font-weight: 800; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.5); transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .p-badge.visible { opacity: 1; transform: scale(1); }

        /* Gold Effect */
        .suggest-gold { border-color: var(--gold) !important; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.3) !important; animation: pulseGold 1.5s infinite; z-index: 10; }
        @keyframes pulseGold { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* --- CART --- */
        .ticket-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .ticket-title { font-weight: 800; font-size: 1.1rem; }
        .last-bill { font-size: 0.8rem; font-weight: 600; color: var(--accent); cursor: pointer; padding: 4px 8px; background: #eff6ff; border-radius: 6px; }
        
        .cart-items { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .cart-row { display: grid; grid-template-columns: 40px 1fr auto 32px; gap: 10px; align-items: center; background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); animation: slideIn 0.2s; }
        .qty-box { background: #eff6ff; color: var(--accent); font-weight: 800; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: 700; font-size: 0.9rem; }
        .item-sub { font-size: 0.8rem; color: var(--text-muted); }
        .del-btn { color: var(--danger); font-size: 1.4rem; cursor: pointer; display: flex; justify-content: center; }

        /* --- ACTIONS --- */
        .action-panel { background: white; padding: 16px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
        .total-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
        .total-label { font-size: 1rem; font-weight: 600; color: var(--text-muted); }
        .total-amount { font-size: 2.5rem; font-weight: 900; line-height: 1; color: var(--primary); }

        .pay-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; height: 75px; }
        .btn-pay { border-radius: var(--radius); font-weight: 800; font-size: 1.2rem; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; transition: transform 0.1s; }
        .btn-pay:active { transform: scale(0.97); }
        .btn-pay:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .bg-cash { background: var(--accent); }
        .bg-pin { background: var(--success); }
        
        .btn-opt { width: 100%; padding: 12px; border-radius: 8px; font-weight: 700; background: var(--bg-body); color: var(--text-muted); border: 1px solid var(--border); display: flex; justify-content: space-between; }
        .btn-opt.active { background: #fff7ed; color: #c2410c; border-color: #f97316; }

        .footer-tools { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .link-danger { color: var(--danger); font-weight: 700; font-size: 0.85rem; text-decoration: underline; cursor: pointer; }

        /* --- MODALS & OVERLAYS --- */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-backdrop.open { display: flex; }
        .modal-content { background: white; width: 600px; max-width: 95%; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-title { font-size: 1.25rem; font-weight: 800; margin: 0; }
        .modal-body { padding: 20px; overflow-y: auto; }

        /* Success Flash */
        #flash-overlay { position: fixed; inset: 0; background: rgba(22, 163, 74, 0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #flash-overlay.visible { opacity: 1; }
        .checkmark { font-size: 8rem; color: white; transform: scale(0.5); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #flash-overlay.visible .checkmark { transform: scale(1); }

        /* Notifications */
        .alert-banner { position: fixed; top: 0; left: 0; right: 0; padding: 20px; text-align: center; font-weight: 800; transform: translateY(-100%); transition: 0.5s; z-index: 1500; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .alert-haccp { background: var(--warning); color: #78350f; }
        .alert-closing { background: var(--danger); color: white; height: 100vh; display: flex; flex-direction: column; justify-content: center; font-size: 3rem; transform: translateY(-120%); }
        .alert-banner.show { transform: translateY(0); }

        /* Utilities */
        @keyframes slideIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        @keyframes blink { 50% { opacity: 0.4; } }
        @keyframes popUp { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .num-key { padding: 20px; font-size: 1.5rem; font-weight: 700; background: #f1f5f9; border-radius: 10px; transition: 0.1s; }
        .num-key:active { background: #e2e8f0; transform: scale(0.95); }

    </style>
</head>
<body>

<div id="flash-overlay"><div class="checkmark">‚úì</div></div>
<div id="haccp-alert" class="alert-banner alert-haccp" onclick="App.ui.hideHaccp()">‚ö†Ô∏è Taartjes Borgen! <br><small>Check temperatuur & lijsten</small></div>
<div id="closing-alert" class="alert-banner alert-closing" onclick="App.ui.hideClosing()">WIJ ZIJN GESLOTEN<br><small style="font-size:1.5rem">Fijne avond!</small></div>

<div id="modal-cash" class="modal-backdrop">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header"><h3>Contant Afrekenen</h3><button onclick="App.ui.closeModal('modal-cash')" style="font-size:2rem; background:none;">&times;</button></div>
        <div class="modal-body">
            <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; font-size:1.1rem; color:var(--text-muted);"><span>Te betalen:</span><span id="cash-req" style="font-weight:bold; color:var(--primary)">‚Ç¨ 0,00</span></div>
                <div style="display:flex; justify-content:space-between; font-size:1.1rem; color:var(--text-muted); margin-top:5px;"><span>Ontvangen:</span><span id="cash-given" style="font-weight:bold; color:var(--accent)">‚Ç¨ 0,00</span></div>
                <div style="border-top:2px dashed #cbd5e1; margin-top:15px; padding-top:15px; display:flex; justify-content:space-between; font-size:1.8rem; font-weight:900; color:var(--danger);"><span>TERUG:</span><span id="cash-change">‚Ç¨ 0,00</span></div>
            </div>
            <div id="cash-options" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;"></div>
            <button onclick="App.payment.confirmCash()" style="width:100%; background:var(--success); color:white; padding:20px; border-radius:12px; font-weight:800; font-size:1.3rem; margin-top:20px;">AFRONDEN</button>
        </div>
    </div>
</div>

<div id="modal-open" class="modal-backdrop">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header"><h3>Open Bedrag</h3><button onclick="App.ui.closeModal('modal-open')" style="font-size:2rem; background:none;">&times;</button></div>
        <div class="modal-body">
            <div id="numpad-display" style="text-align:right; font-size:2.5rem; font-weight:900; background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:10px;">0,00</div>
            <div class="numpad" id="numpad-keys"></div>
        </div>
    </div>
</div>

<div id="modal-history" class="modal-backdrop">
    <div class="modal-content" style="width: 700px;">
        <div class="modal-header"><h3>Bon Historie</h3><button onclick="App.ui.closeModal('modal-history')" style="font-size:2rem; background:none;">&times;</button></div>
        <div class="modal-body" id="history-list" style="background:#f1f5f9; min-height:300px;"></div>
    </div>
</div>

<div id="modal-manager" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header" style="background:#1e293b; color:white;"><h3>üïµÔ∏è Manager</h3><button onclick="App.ui.closeModal('modal-manager')" style="font-size:2rem; background:none; color:white;">&times;</button></div>
        <div class="modal-body">
            <h4>Sessie Afsluiten</h4>
            <div id="session-stats" style="margin-bottom:20px;"></div>
            <button onclick="App.manager.resetSession()" style="width:100%; padding:20px; background:var(--danger); color:white; font-weight:bold; border-radius:10px;">NU AFSLUITEN & WISSEN</button>
            <hr style="margin:20px 0;">
            <h4>Tools</h4>
            <label style="display:flex; align-items:center; gap:10px; padding:10px; background:#f1f5f9; border-radius:8px; margin-bottom:10px;">
                <input type="checkbox" id="chk-training" onchange="App.settings.toggleTraining()" style="width:20px; height:20px;">
                <span style="font-weight:bold;">Trainingsmodus (Geen opslag)</span>
            </label>
        </div>
    </div>
</div>

<div class="app-container" id="app-wrapper">
    <div class="left-panel">
        <div class="top-bar" id="top-bar">
            <div class="brand" onclick="App.manager.secretKnock()">MuseumCatering</div>
            <div class="status-indicators">
                <div class="status-pill">üîã <span id="bat-level">--%</span></div>
                <div class="status-pill"><div class="dot ok" id="net-dot"></div> <span id="net-text">Online</span></div>
                <div class="status-pill">üïí <span id="clock">00:00</span></div>
            </div>
        </div>
        
        <div class="cat-scroll" id="cat-tabs"></div>
        <div class="product-grid" id="prod-grid"></div>
    </div>

    <div class="right-panel">
        <div class="ticket-header">
            <div class="ticket-title">Huidige Bon</div>
            <div class="last-bill" onclick="App.ui.openHistory()">Laatste: <span id="last-bill-amt">‚Ç¨ 0,00</span></div>
        </div>
        
        <div class="cart-items" id="cart-list"></div>
        
        <div class="action-panel">
            <div class="total-row">
                <span class="total-label">TOTAAL</span>
                <span class="total-amount" id="total-display">‚Ç¨ 0,00</span>
            </div>
            
            <div class="pay-grid">
                <button class="btn-pay bg-cash" id="btn-cash" onclick="App.payment.startCash()">CONTANT</button>
                <button class="btn-pay bg-pin" id="btn-pin" onclick="App.payment.payPin()">PIN DIRECT</button>
            </div>
            
            <button class="btn-opt" id="btn-disc" onclick="App.cart.toggleDiscount()">
                <span>% Personeelskorting</span>
                <span id="disc-status" style="font-weight:800; color:var(--text-main);">UIT</span>
            </button>
            
            <div class="footer-tools">
                <span class="link-danger" onclick="App.cart.clear()">√ó Bon Wissen</span>
                <span onclick="App.ui.openManager()" style="font-size:1.2rem; cursor:pointer; color:var(--text-muted);">‚öôÔ∏è</span>
            </div>
        </div>
        <div style="background:#111827; color:#fcd34d; padding:8px; text-align:center; font-weight:700; font-size:0.75rem; letter-spacing:1px;">‚ö†Ô∏è ALLEEN INVOEREN</div>
    </div>
</div>

<script>
/**
 * MUSEUMCATERING POS ENGINE V2.0
 * Architectuur: Modular Namespace
 * Focus: Stabiliteit, Anti-Dubbelingen, Data Integriteit
 */

const CONFIG = {
    // PLAK HIER JE NIEUWE URL UIT DE VORIGE STAP:
    GOOGLE_URL: "https://script.google.com/macros/s/AKfycbw4HCKu5DRqDvC6SsqdxhpVviAlSc1Se18gsQFSOEA70h2DkOHI6OBpb_ca4kxccMfjMA/exec",
    CATS: ["Frisdrank", "Warme Dranken", "Alcohol", "Zoetigheden", "Brood/Warm", "Diversen"],
    PRODUCTS: [
        {c:0, n:"Chocomel", p:3.50}, {c:0, n:"Cola", p:3.50}, {c:0, n:"Cola Zero", p:3.50}, {c:0, n:"Spa Blauw", p:3.50}, {c:0, n:"Spa Rood", p:3.50}, {c:0, n:"Schulp Appel", p:3.85}, {c:0, n:"Schulp Vlierbes", p:3.85}, {c:0, n:"Lemon-aid Passie", p:4.75}, {c:0, n:"Lemon-aid Bloed", p:4.75}, {c:0, n:"Lemon-aid Ginger", p:4.75}, {c:0, n:"Charitea", p:4.75}, {c:0, n:"Melk", p:3.00}, {c:0, n:"Karnemelk", p:3.00}, {c:0, n:"Verse Jus", p:5.25}, {c:0, n:"Glas Limonade", p:1.00}, {c:0, n:"Sinaasappel Aardbei", p:5.25},
        {c:1, n:"Koffie", p:3.40}, {c:1, n:"Cappuccino", p:3.75}, {c:1, n:"Koffie Verkeerd", p:4.20}, {c:1, n:"Latte Macchiato", p:4.20}, {c:1, n:"Flat White", p:4.20}, {c:1, n:"Espresso", p:3.40}, {c:1, n:"Espresso Macch.", p:3.45}, {c:1, n:"Dubbele Espresso", p:4.00}, {c:1, n:"Havermelk", p:0.60}, {c:1, n:"Thee", p:3.50}, {c:1, n:"Gember Thee", p:3.95}, {c:1, n:"Munt Thee", p:3.95}, {c:1, n:"Warme Choco", p:3.95}, {c:1, n:"Slagroom", p:0.75},
        {c:2, n:"DHP Pilsener", p:5.00}, {c:2, n:"DHP Weizener", p:5.50}, {c:2, n:"DHP IPA", p:5.50}, {c:2, n:"Leffe", p:5.25}, {c:2, n:"Hertog Jan", p:3.75}, {c:2, n:"Glas Wijn", p:5.25},
        {c:3, n:"Appeltaart", p:5.50}, {c:3, n:"Worteltaart", p:5.50}, {c:3, n:"Titanic Gold", p:5.50}, {c:3, n:"Citroen Meringue", p:5.50}, {c:3, n:"Croissant", p:3.50}, {c:3, n:"Pain au Chocolat", p:3.50}, {c:3, n:"Slagroom", p:0.75}, {c:3, n:"Brownie", p:4.95}, {c:3, n:"Macaron", p:2.00}, {c:3, n:"Kinderdonut", p:3.50}, {c:3, n:"Poffertjes", p:3.95}, {c:3, n:"IJsje", p:2.00},
        {c:4, n:"Br. Oude Kaas", p:9.50}, {c:4, n:"Br. Tonijn", p:9.50}, {c:4, n:"Br. Gr. Groenten", p:9.50}, {c:4, n:"Br. Gehaktbal", p:9.50}, {c:4, n:"Salade Tonijn", p:12.00}, {c:4, n:"Sal. Geitenkaas", p:12.00}, {c:4, n:"Kaasbroodje", p:3.75}, {c:4, n:"Saucijsbroodje", p:3.75}, {c:4, n:"Quiche", p:3.95}, {c:4, n:"Soep", p:6.50}, {c:4, n:"Soepbroodje", p:0.50},
        {c:5, n:"Open Bedrag", p:0, special:true}
    ]
};

// --- STATE MANAGEMENT ---
const State = {
    cart: [],
    queue: JSON.parse(localStorage.getItem('mc_queue')) || [],
    history: JSON.parse(localStorage.getItem('mc_history')) || [],
    activeCat: 0,
    discount: false,
    training: false,
    isProcessing: false, // CRUCIAAL: Voorkomt dubbel klikken
    numpadVal: "",
    lastCashGiven: 0,
    knockCount: 0
};

// --- UTILS ---
const Utils = {
    formatPrice: (num) => `‚Ç¨ ${num.toFixed(2).replace('.', ',')}`,
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    vibrate: () => { if(navigator.vibrate) navigator.vibrate(15); },
    beep: () => { /* Sound implementatie indien nodig */ },
    
    // Veilig rekenen (voorkomt 0.300000004 errors)
    round: (num) => Math.round(num * 100) / 100
};

// --- CORE MODULES ---

const App = {
    init: () => {
        App.ui.renderCats();
        App.ui.renderGrid();
        App.ui.renderCart();
        App.ui.updateClock();
        App.ui.initNumpad();
        App.net.startQueueProcessor();
        App.net.initBattery();
        
        setInterval(App.ui.updateClock, 1000);
        setInterval(App.ui.checkBusyLevel, 5000); // Thermometer
    },

    cart: {
        add: (name, price, catIdx) => {
            if(State.isProcessing) return;
            let item = State.cart.find(x => x.n === name);
            if(item) item.q++;
            else State.cart.push({ n:name, p:price, q:1, c:catIdx });
            
            // Gold Effect Trigger (Bij Warme Drank -> Zoet Highlight)
            if(catIdx === 1) App.ui.triggerGold();
            
            App.ui.renderCart();
            App.ui.renderGrid(); // Update badges
            Utils.vibrate();
        },
        remove: (idx) => {
            if(State.cart[idx].q > 1) State.cart[idx].q--;
            else State.cart.splice(idx, 1);
            App.ui.renderCart();
            App.ui.renderGrid();
        },
        deleteRow: (idx) => {
            State.cart.splice(idx, 1);
            App.ui.renderCart();
            App.ui.renderGrid();
        },
        clear: () => {
            if(confirm("Bon wissen?")) {
                State.cart = [];
                State.discount = false;
                App.ui.renderCart();
                App.ui.renderGrid();
            }
        },
        toggleDiscount: () => {
            State.discount = !State.discount;
            App.ui.renderCart();
        },
        calculateTotal: () => {
            let sub = State.cart.reduce((a, b) => a + (b.p * b.q), 0);
            return State.discount ? Utils.round(sub * 0.75) : Utils.round(sub);
        }
    },

    payment: {
        startCash: () => {
            if(State.cart.length === 0 || State.isProcessing) return;
            const total = App.cart.calculateTotal();
            
            document.getElementById('cash-req').innerText = Utils.formatPrice(total);
            document.getElementById('cash-given').innerText = "‚Ç¨ 0,00";
            document.getElementById('cash-change').innerText = "‚Ç¨ 0,00";
            
            // Genereer knoppen
            const opts = [total];
            if(total % 5 !== 0) opts.push(Math.ceil(total/5)*5);
            if(total % 10 !== 0) opts.push(Math.ceil(total/10)*10);
            if(total < 20) opts.push(20);
            if(total < 50) opts.push(50);
            
            const grid = document.getElementById('cash-options');
            grid.innerHTML = [...new Set(opts)].sort((a,b)=>a-b).map(amt => 
                `<button class="btn-pay" style="background:white; color:var(--primary); border:2px solid var(--border); font-size:1rem; height:60px;" 
                onclick="App.payment.selectCash(${amt}, ${total})">‚Ç¨ ${amt.toFixed(2)}</button>`
            ).join('');
            
            State.lastCashGiven = 0;
            App.ui.openModal('modal-cash');
        },
        selectCash: (amt, total) => {
            State.lastCashGiven = amt;
            document.getElementById('cash-given').innerText = Utils.formatPrice(amt);
            document.getElementById('cash-change').innerText = Utils.formatPrice(amt - total);
        },
        confirmCash: () => {
            if(State.lastCashGiven === 0) State.lastCashGiven = App.cart.calculateTotal(); // Pas gepast
            App.ui.closeModal('modal-cash');
            App.payment.process("CONTANT");
        },
        payPin: () => {
            if(State.cart.length === 0 || State.isProcessing) return;
            App.payment.process("PIN");
        },
        process: (type) => {
            // 1. LOCK UI (Anti-Dubbel)
            State.isProcessing = true;
            App.ui.setLoading(true);

            if(State.training) {
                App.ui.flashSuccess();
                State.cart = [];
                State.discount = false;
                App.ui.renderCart();
                App.ui.renderGrid();
                State.isProcessing = false;
                App.ui.setLoading(false);
                return;
            }

            // 2. DATA PREP
            const total = App.cart.calculateTotal();
            const itemsFlat = [];
            const breakdown = {};
            
            State.cart.forEach(item => {
                // Item lijst voor display
                itemsFlat.push(`${item.q}x ${item.n}`);
                
                // Categorie breakdown voor Journaal (Backend matcht op Naam)
                const catName = CONFIG.CATS[item.c] || "Diversen";
                if(!breakdown[catName]) breakdown[catName] = 0;
                breakdown[catName] += (item.p * item.q);
            });
            
            // Korting verrekenen in breakdown
            if(State.discount) {
                for(let k in breakdown) breakdown[k] = Utils.round(breakdown[k] * 0.75);
            } else {
                for(let k in breakdown) breakdown[k] = Utils.round(breakdown[k]);
            }

            const record = {
                id: Utils.uuid(),
                time: new Date().toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit'}),
                type: type,
                total: total,
                items: itemsFlat,
                catBreakdown: breakdown, // Dit is wat code.gs nodig heeft voor kolommen F-K
                isDiscounted: State.discount,
                device: "Tablet V2"
            };

            // 3. STORE & SYNC
            State.history.push(record);
            localStorage.setItem('mc_history', JSON.stringify(State.history));
            
            App.net.addToQueue(record);
            
            // 4. RESET & FEEDBACK
            State.cart = [];
            State.discount = false;
            App.ui.flashSuccess();
            App.ui.renderCart();
            App.ui.renderGrid();
            App.ui.updateLastBill();
            
            // Unlock na animatie
            setTimeout(() => { 
                State.isProcessing = false; 
                App.ui.setLoading(false);
            }, 1000);
        }
    },

    net: {
        addToQueue: (data) => {
            State.queue.push({ data: data, retries: 0 });
            localStorage.setItem('mc_queue', JSON.stringify(State.queue));
            App.net.processQueue();
        },
        processQueue: () => {
            if(State.queue.length === 0 || !navigator.onLine) {
                App.ui.updateNetStatus();
                return;
            }
            
            const job = State.queue[0];
            
            // GEBRUIK NO-CORS (Snelheid) MAAR MET CLIENT-SIDE DEDUPE
            fetch(CONFIG.GOOGLE_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(job.data)
            })
            .then(() => {
                // We nemen aan dat het gelukt is bij no-cors
                State.queue.shift();
                localStorage.setItem('mc_queue', JSON.stringify(State.queue));
                if(State.queue.length > 0) setTimeout(App.net.processQueue, 300);
                App.ui.updateNetStatus();
            })
            .catch(err => {
                console.error("Sync fail", err);
                App.ui.updateNetStatus();
            });
        },
        startQueueProcessor: () => {
            window.addEventListener('online', () => { App.net.processQueue(); App.ui.updateNetStatus(); });
            window.addEventListener('offline', App.ui.updateNetStatus);
            setInterval(App.net.processQueue, 10000); // Fail-safe elke 10 sec
        },
        initBattery: () => {
            if(navigator.getBattery) {
                navigator.getBattery().then(bat => {
                    const update = () => document.getElementById('bat-level').innerText = Math.round(bat.level*100) + "%";
                    update(); bat.addEventListener('levelchange', update);
                });
            }
        }
    },

    ui: {
        renderCats: () => {
            const html = CONFIG.CATS.map((name, i) => 
                `<button class="cat-btn ${i===State.activeCat ? 'active' : ''}" onclick="App.ui.setCat(${i})">${name}</button>`
            ).join('');
            document.getElementById('cat-tabs').innerHTML = html;
        },
        setCat: (i) => {
            State.activeCat = i;
            App.ui.renderCats();
            App.ui.renderGrid();
        },
        renderGrid: () => {
            const items = CONFIG.PRODUCTS.filter(p => p.c === State.activeCat);
            document.getElementById('prod-grid').innerHTML = items.map(p => {
                const inCart = State.cart.find(x => x.n === p.n);
                const badge = inCart ? `<div class="p-badge visible">${inCart.q}</div>` : `<div class="p-badge"></div>`;
                const action = p.special ? `App.ui.openNumpad()` : `App.cart.add('${p.n}', ${p.p}, ${p.c})`;
                const price = p.special ? "..." : Utils.formatPrice(p.p);
                // Extra class voor Gold Effect Target (Zoetigheden = Cat 3)
                const extraClass = (p.c === 3) ? 'suggest-target' : '';
                
                return `<div class="p-card cat-style-${p.c} ${extraClass}" onclick="${action}">
                    ${badge}
                    <div class="p-name">${p.n}</div>
                    <div class="p-price">${price}</div>
                </div>`;
            }).join('');
        },
        renderCart: () => {
            const list = document.getElementById('cart-list');
            if(State.cart.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#cbd5e1; margin-top:50px;">üõí<br>Bon is leeg</div>`;
            } else {
                list.innerHTML = State.cart.map((item, i) => `
                    <div class="cart-row">
                        <div class="qty-box" onclick="App.cart.add('${item.n}', ${item.p}, ${item.c})">${item.q}</div>
                        <div class="item-info">
                            <span class="item-name">${item.n}</span>
                            <span class="item-sub">${Utils.formatPrice(item.p)}</span>
                        </div>
                        <div style="font-weight:700;">${Utils.formatPrice(item.p * item.q)}</div>
                        <div class="del-btn" onclick="App.cart.remove(${i})">&minus;</div>
                    </div>
                `).join('');
                setTimeout(() => list.scrollTop = list.scrollHeight, 10);
            }
            
            // Totalen
            const total = App.cart.calculateTotal();
            document.getElementById('total-display').innerText = Utils.formatPrice(total);
            
            // Knoppen Status
            const disabled = State.cart.length === 0 || State.isProcessing;
            document.getElementById('btn-cash').disabled = disabled;
            document.getElementById('btn-pin').disabled = disabled;
            
            // Discount UI
            const btnDisc = document.getElementById('btn-disc');
            const lblDisc = document.getElementById('disc-status');
            if(State.discount) {
                btnDisc.classList.add('active');
                lblDisc.innerText = "AAN (25%)";
            } else {
                btnDisc.classList.remove('active');
                lblDisc.innerText = "UIT";
            }
        },
        triggerGold: () => {
            const targets = document.querySelectorAll('.suggest-target');
            targets.forEach(el => el.classList.add('suggest-gold'));
            setTimeout(() => targets.forEach(el => el.classList.remove('suggest-gold')), 5000);
        },
        setLoading: (busy) => {
            const wrap = document.getElementById('app-wrapper');
            if(busy) wrap.style.opacity = "0.7"; else wrap.style.opacity = "1";
        },
        flashSuccess: () => {
            const el = document.getElementById('flash-overlay');
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 600);
        },
        openModal: (id) => document.getElementById(id).classList.add('open'),
        closeModal: (id) => document.getElementById(id).classList.remove('open'),
        
        // --- NUMPAD LOGIC ---
        openNumpad: () => { State.numpadVal = ""; App.ui.updateNumpad(); App.ui.openModal('modal-open'); },
        initNumpad: () => {
            const keys = [7,8,9,4,5,6,1,2,3,'.',0,'OK'];
            document.getElementById('numpad-keys').innerHTML = keys.map(k => {
                const bg = k === 'OK' ? 'var(--success)' : '#f1f5f9';
                const col = k === 'OK' ? 'white' : 'var(--primary)';
                const action = k === 'OK' ? 'App.ui.confirmNumpad()' : `App.ui.typeNumpad('${k}')`;
                return `<button class="num-key" style="background:${bg}; color:${col}" onclick="${action}">${k}</button>`;
            }).join('');
        },
        typeNumpad: (char) => {
            State.numpadVal += char;
            App.ui.updateNumpad();
        },
        updateNumpad: () => {
            document.getElementById('numpad-display').innerText = State.numpadVal || "0.00";
        },
        confirmNumpad: () => {
            let clean = State.numpadVal.replace(',', '.');
            let val = parseFloat(clean);
            if(val > 0) App.cart.add("Diversen", val, 5);
            App.ui.closeModal('modal-open');
        },

        // --- CLOCK & ALERTS ---
        updateClock: () => {
            const now = new Date();
            const str = now.toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('clock').innerText = str;
            
            // HACCP logic (10, 12, 14, 16 uur)
            const h = now.getHours(); const m = now.getMinutes(); const s = now.getSeconds();
            if([10,12,14,16].includes(h) && m===0 && s===0) {
                document.getElementById('haccp-alert').classList.add('show');
                setTimeout(App.ui.hideHaccp, 30000);
            }
            if(h===16 && m===45 && s===0) document.getElementById('closing-alert').classList.add('show');
        },
        hideHaccp: () => document.getElementById('haccp-alert').classList.remove('show'),
        hideClosing: () => document.getElementById('closing-alert').classList.remove('show'),
        
        // --- HISTORY & MANAGER ---
        updateLastBill: () => {
            if(State.history.length === 0) return;
            const last = State.history[State.history.length-1];
            document.getElementById('last-bill-amt').innerText = Utils.formatPrice(last.total);
        },
        openHistory: () => {
            const container = document.getElementById('history-list');
            if(State.history.length === 0) {
                container.innerHTML = "<div style='padding:20px; text-align:center'>Geen historie</div>";
            } else {
                container.innerHTML = State.history.slice().reverse().map(h => `
                    <div style="background:white; padding:12px; margin-bottom:8px; border-radius:8px; border:1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span>${h.time} (${h.type})</span>
                            <span>${Utils.formatPrice(h.total)}</span>
                        </div>
                        <div style="font-size:0.85rem; color:var(--text-muted); margin:4px 0;">${h.items.join(', ')}</div>
                        <button onclick="App.manager.undo(${h.id}, ${h.total}, '${h.type}', '${h.items}')" style="background:#fee2e2; color:#b91c1c; font-size:0.75rem; padding:4px 8px; border-radius:4px; font-weight:bold;">CORRECTIE / UNDO</button>
                    </div>
                `).join('');
            }
            App.ui.openModal('modal-history');
        },
        openManager: () => {
            // Sessie samenvatting
            let pin=0, cash=0;
            State.history.forEach(h => { if(h.type==="PIN") pin+=h.total; else cash+=h.total; });
            document.getElementById('session-stats').innerHTML = `
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; margin-bottom:5px;"><span>Totaal PIN:</span><span style="color:var(--success)">${Utils.formatPrice(pin)}</span></div>
                <div style="display:flex; justify-content:space-between; font-size:1.2rem;"><span>Totaal CASH:</span><span style="color:var(--accent)">${Utils.formatPrice(cash)}</span></div>
            `;
            App.ui.openModal('modal-manager');
        },
        updateNetStatus: () => {
            const dot = document.getElementById('net-dot');
            const txt = document.getElementById('net-text');
            if(!navigator.onLine) { dot.className="dot err"; txt.innerText="Offline"; }
            else if(State.queue.length > 0) { dot.className="dot sync"; txt.innerText="Syncing..."; }
            else { dot.className="dot ok"; txt.innerText="Online"; }
        },
        checkBusyLevel: () => {
            // Thermometer functie
            const now = Date.now();
            const recent = State.history.filter(h => String(h.id).length > 10 ? true : false).filter(h => (now - parseInt(h.id.substring(0,8), 36)) < 60000).length; // Ruwe schatting obv ID of timestamp
            // Simpelere methode: check timestamps in history
            // (Niet kritiek voor operatie, overgeslagen voor stabiliteit)
        }
    },

    manager: {
        undo: (id, total, type, items) => {
            if(!confirm("Bon crediteren? Dit stuurt een negatief bedrag naar de administratie.")) return;
            
            // Verwijder lokaal
            State.history = State.history.filter(h => h.id !== id);
            localStorage.setItem('mc_history', JSON.stringify(State.history));
            
            // Stuur correctie
            const record = {
                id: Utils.uuid(),
                time: new Date().toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit'}),
                type: type,
                total: -Math.abs(total), // Forceer negatief
                items: ["CORRECTIE: " + items],
                catBreakdown: {}, // Leeg, of specifieke tegenboeking indien gewenst (hier generiek)
                isDiscounted: false,
                device: "Tablet Correctie"
            };
            
            App.net.addToQueue(record);
            App.ui.openHistory(); // Refresh list
            App.ui.updateLastBill();
        },
        resetSession: () => {
            if(confirm("Sessie afsluiten en alle historie wissen?")) {
                State.history = [];
                localStorage.setItem('mc_history', JSON.stringify([]));
                // Eventueel reset signaal naar server
                location.reload();
            }
        },
        secretKnock: () => {
            State.knockCount++;
            if(State.knockCount === 5) {
                App.ui.openManager();
                State.knockCount = 0;
            }
            setTimeout(() => State.knockCount=0, 2000);
        }
    },
    
    settings: {
        toggleTraining: () => {
            State.training = document.getElementById('chk-training').checked;
            const bar = document.getElementById('top-bar');
            if(State.training) bar.classList.add('training-mode'); else bar.classList.remove('training-mode');
        }
    }
};

// BOOT
window.onload = App.init;

</script>
</body>
</html>
