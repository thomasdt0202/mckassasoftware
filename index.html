/* --- GEFIXTE TRANSACTION LOGICA --- */
function finishTransaction(type) {
    if(cart.length === 0 || isTransactionInProgress) return;
    
    isTransactionInProgress = true; // DIRECTE LOCK

    // Visuele feedback
    const flash = document.getElementById('flash');
    flash.classList.add('visible');
    setTimeout(() => flash.classList.remove('visible'), 500);

    if(trainingMode) {
        cart = []; discount = false; updateDiscBtn(); renderCart(); 
        isTransactionInProgress = false;
        return;
    }
    
    let sub = cart.reduce((a,b) => a + (b.p*b.qty), 0);
    if(discount) sub = sub * 0.75;

    // ... (rest van je record opbouw blijft gelijk) ...
    
    // VEILIG OPSLAAN
    try {
        queue.push({ data: record, retries: 0 });
        saveQueue(); 
        processQueue(); // Start direct met verzenden
        
        lastTransaction = record;
        cart = [];
        discount = false;
        updateDiscBtn();
        renderCart();
        updateLastBill();
        
        showToast("Betaald: â‚¬" + sub.toFixed(2), "OEPS, HERSTEL", undoPayment);
    } catch (e) {
        alert("Fout bij opslaan: " + e.message);
    } finally {
        // Iets langere lock om per ongeluk dubbel tikken te voorkomen
        setTimeout(() => { isTransactionInProgress = false; }, 1500);
    }
}

/* --- GEFIXTE OPEN BEDRAG LOGICA --- */
function confirmOpen() {
    // Vervang komma door punt voordat we rekenen
    let cleanedNum = numStr.replace(',', '.');
    let val = parseFloat(cleanedNum);
    if(!isNaN(val) && val > 0) {
        addToCart("Diversen", val);
        closeOpen();
    } else {
        alert("Ongeldig bedrag");
    }
}

/* --- GEFIXTE QUEUE LOGICA (STOPT DATA-VERLIES) --- */
function processQueue() {
    if(queue.length === 0 || !navigator.onLine) {
        updateStatus();
        return;
    }
    
    let job = queue[0];
    
    // Verwijder 'no-cors' om echte fouten te kunnen vangen
    fetch(GOOGLE_URL, {
        method: 'POST',
        headers: {'Content-Type': 'text/plain;charset=utf-8'}, // Apps Script houdt van text/plain
        body: JSON.stringify(job.data)
    })
    .then(response => {
        // Alleen verwijderen als de server zegt dat het OK is
        queue.shift();
        saveQueue();
        if(queue.length > 0) setTimeout(processQueue, 300);
    })
    .catch(err => {
        console.error("Sync fout, blijft in wachtrij:", err);
        updateStatus();
    });
}
